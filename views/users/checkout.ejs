<%- include('../layouts/user/header.ejs') %>
    <!-- Topbar Start -->

    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid">
        <div class="row border-top px-xl-5">
            <div class="col-lg-3 d-none d-lg-block">
                <a class="btn shadow-none d-flex align-items-center justify-content-between bg-primary text-white w-100"
                    data-toggle="collapse" href="#navbar-vertical"
                    style="height: 65px; margin-top: -1px; padding: 0 30px;">
                    <h6 class="m-0">checkout</h6>

                </a>

            </div>
            <div class="col-lg-9">
                <nav class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-0">
                    <a href="" class="text-decoration-none d-block d-lg-none">
                        <h1 class="m-0 display-5 font-weight-semi-bold"><span
                                class="text-primary font-weight-bold border px-3 mr-1">E</span>Shopper</h1>
                    </a>
                    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                        <div class="navbar-nav mr-auto py-0">
                            <a href="/" class="nav-item nav-link">Home</a>
                            <a href="/shop" class="nav-item nav-link">Shop</a>



                        </div>
                        <div class="navbar-nav ml-auto py-0">
                            <a href="" class="nav-item nav-link">Login</a>
                            <a href="" class="nav-item nav-link">Register</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </div>
    <!-- Navbar End -->


    <!-- Page Header Start -->
    <div class="container-fluid bg-secondary mb-5">
        <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px">
            <h1 class="font-weight-semi-bold text-uppercase mb-3">Checkout</h1>
            <div class="d-inline-flex">
                <p class="m-0"><a href="/">Home</a></p>
                <p class="m-0 px-2">-</p>
                <p class="m-0"><a href="/cart">Cart</a></p>
                <p class="m-0 px-2">-</p>
                <p class="m-0">Checkout</p>
            </div>
        </div>
    </div>
    <!-- Page Header End -->


    <!-- Checkout Start -->
    <div class="container-fluid pt-5">
        <div class="row px-xl-5">
            <div class="col-lg-8">
                <div class="mb-4 ">
                    <!-- ======form -->
                    <!-- form ===== -->
                    <form action="/proceedToCheckout" id="orderform" method="post">
                        <!-- ======== -->
                        <h4 class="font-weight-semi-bold mb-4 ">Billing Address</h4>
                        <div class="row ">
                            <div class="col-md-6 form-group">

                                <!-- ======== option=====-->
                                <label>Another address</label>
                                <select id="my-select" class="form-select btn form-control col-md-6 btn-primary "
                                    name="select" aria-label="Address option">

                                    <option value="addnewbill" class="text-uppercase" selected>Add New address</option>
                                    <% user.address.forEach(element=> { %>
                                        <option class="col-md-12 form-group" value="<%= element._id %>">
                                            <%= element.Address_Line %>
                                        </option>



                                        <% }) %>


                                </select>

                                <!-- <a href="">
                                <button class="btn form-control  btn-primary">
                                    select Another address
                                </button>
                            </a> -->

                            </div>
                            <div class="col-md-6 form-group">
                                <label>First Name</label>
                                <input class="form-control xx" type="text" id="fname" name="fname" required>
                                <span class="error text-danger" id="name-error"></span>
                            </div>

                            <div class="col-md-6 form-group">
                                <label>Last Name</label>
                                <input class="form-control xx" type="text" id="lname" name="lname" required>
                                <span class="error text-danger" id="lname-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>E-mail</label>
                                <input class="form-control xx" type="text" id="email" name="email" required>
                                <span class="error text-danger" id="email-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Mobile No</label>
                                <input class="form-control xx" type="text" id="Mobile" name="Mobile" required>
                                <span class="error text-danger" id="phone-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>Address Line 1</label>
                                <input class="form-control xx" type="text" id="address" name="address" required>
                                <span class="error text-danger" id="house-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>country</label>
                                <input class="form-control xx" type="text" id="country" name="country" required>
                                <span class="error text-danger" id="country-error"></span>
                            </div>

                            <div class="col-md-6 form-group">
                                <label>City</label>
                                <input class="form-control xx" type="text" id="city" name="city" required>
                                <span class="error text-danger" id="district-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>State</label>
                                <input class="form-control  xx" type="text" id="state" name="state" required>
                                <span class="error text-danger" id="state-error"></span>
                            </div>
                            <div class="col-md-6 form-group">
                                <label>ZIP Code</label>
                                <input class="form-control xx" type="text" id="zipCode" name="zipCode" required>
                                <span class="error text-danger" id="pincode-error"></span>
                            </div>
                            



                          


                        </div>
                </div>
                <!-- ============================= -->

            </div>
            <!-- ============================= -->


            <!-- shiping -->
            <!-- form -->

            <div class="col-lg-4">

                <div class="card border-secondary mb-5">

                    <div class="card-header bg-secondary border-0">
                        <h4 class="font-weight-semi-bold m-0">Order Total</h4>
                        <div class="card-body">
                            <h5 class="font-weight-medium mb-3">Products</h5>
                            <!-- ======================== -->





                            <% for( let i=0; i < user.cart.length; i++ ) { %>

                                <div class="d-flex justify-content-between mb-3 pt-1 ">


                                    <p>
                                        <%= user.cart[i].products.name %>
                                    </p>

                                    <p>$ <%= user.cart[i].totalprice %>
                                    </p>




                                </div>
                                <% } %>
                                    <p id="grandTotals"></p>



                                    <hr class="mt-0">
                                    <div class="d-flex justify-content-between mb-3 pt-1">
                                        <h6 class="font-weight-medium">Subtotal</h6>

                                        <h6 class="font-weight-medium" id="total">
                                            <%= user.grandtotal %>
                                        </h6>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <h6 class="font-weight-medium">Shipping</h6>
                                        <h6 class="font-weight-medium">$</h6>
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <h6 class="font-weight-medium">Discount</h6>
                                        <h6 class="font-weight-medium" id="percentage"></h6>
                                    </div>
                                    <span class="error text-danger" id="messa"></span>
                        </div>
                        <div class="card-footer border-secondary bg-transparent">
                            <div class="d-flex justify-content-between mt-2">
                                <h5 class="font-weight-bold">Total</h5>
                                <h5 class="font-weight-bold" id="grandTotal">
                                    <%= user.grandtotal %>
                                </h5>
                            </div>

                        </div>
                    </div>

                    <div class="card border-secondary mb-5">
                        <div class="card-header bg-secondary border-0">
                            <h4 class="font-weight-semi-bold m-0">Payment</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="payment" value="razorpay"
                                        required id="paypal">
                                    <label class="custom-control-label" for="paypal">Razorpay</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" name="payment" value="cod"
                                        id="directcheck">
                                    <label class="custom-control-label" for="directcheck">Cash On Delivery</label>
                                </div>
                            </div>
                            <div class="">
                                <div class="custom-control custom-radio">
                                    <input type="radio" class="custom-control-input" value="wallet" name="payment"
                                        id="banktransfer" <% if(user.grandtotal>user.wallet){ %> disabled <% } %> >
                                        <label class="custom-control-label" for="banktransfer">Wallet($<span
                                                class="text-danger ">
                                                <%= user.wallet%>
                                            </span>)<% if(user.grandtotal>user.wallet){ %> Not Applicable <% } %>
                                        </label>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer border-secondary bg-transparent">
                            <button class="btn btn-lg btn-block btn-primary font-weight-bold my-3 py-3"
                                id="submit-button" type="submit">Place
                                Order</button>
                        </div>

                    </div>
                    </form>
                    <div class="input-group pl-4 pb-4">
                        <button type="button" class="btn bg-primary" data-toggle="modal"
                            data-target="#exampleModalLong">AVAILABLE COUPON</button>
                        <span style="color: brown;" id="messa"></sp#565656;an>

                    </div>
                    <div class="modal fade " id="exampleModalLong" tabindex="-1" role="dialog"
                        aria-labelledby="exampleModalLongTitle" aria-hidden="true" style="margin-top: 75px;">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header bg-danger">

                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <% if(coupons.length>0){ %>
                                    <% for(let i=0;i<coupons.length;i++){ %>
                                        <div class="modal-body bg-danger">
                                            <div class="container " id="coupon-container">

                                                <div class="card-coupon">
                                                    <div class="main">
                                                        <div class="co-img">
                                                            <img src="img/logo.jpg" alt="" />
                                                        </div>

                                                        <div class="vertical"></div>

                                                        <div class="content">
                                                            <h5>
                                                                <%= coupons[i].couponName %>
                                                            </h5>
                                                            <h5>Code:<%= coupons[i].couponId %>
                                                            </h5>
                                                            <h5>Valid till: <%= coupons[i].expiryDate %>
                                                            </h5>
                                                            <h6>
                                                                <%= coupons[i].discount %>% - <%=
                                                                        coupons[i].max_discount %>%<span>on
                                                                            minimum
                                                                            <%= coupons[i].minAmount %> - <%=
                                                                                    coupons[i].maxAmount %>
                                                                        </span>
                                                            </h6>

                                                        </div>
                                                    </div>
                                                    <div class="copy-button">
                                                        <input id="copyvalue" type="text" readonly
                                                            value="<%= coupons[i].couponId %>" />
                                                        <button onclick="copyIt()" class="copybtn">COPY</button>
                                                    </div>
                                                </div>

                                            </div>

                                        </div>

                                        <%} %>
                                            <%}else{ %>
                                                <h2 style="text-align: center;">NO COUPON AVAILABLE</h2>
                                                <% } %>

                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <input type="text" id="coupon" class="form-control p-4" placeholder="Coupon Code">
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="discount()">Apply Coupon</button>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- Checkout End -->
        <script>
            let copybtn = document.querySelector(".copybtn");


            function copyIt() {
                let copyInput = document.querySelector('#copyvalue');

                copyInput.select();

                document.execCommand("copy");

                copybtn.textContent = "COPIED";
            }
        </script>
        <!-- ajax address -->
        <script>
            $(function () {
                $('#my-select').on('change', function () {
                    var value = $(this).val();
                    console.log(value)
                    if (value !== "addnewbill") {
                        $.ajax({
                            url: '/checkoutAddres',
                            type: 'POST',
                            data: { value: value },
                            success: function (response) {
                                // console.log(response.state)
                                //   $('#fname').val(response.firtName);
                                $('#fname').val(response.firtName);
                                $('#lname').val(response.lastName);
                                $('#email').val(response.E_mail);
                                $('#Mobile').val(response.MobileNo);
                                $('#address').val(response.Address_Line);
                                $('#country').val(response.country);
                                $('#city').val(response.city);
                                $('#state').val(response.state);
                                $('#zipCode').val(response.zipCode);
                            }
                        });
                    } else {
                        $('.xx').val('');

                    }
                });
            });
        </script>
        <!-- <script>
            function discount() {
                var text="heai"
                document.getElementById('percentage').innerHTML = text
                document.getElementById('grandTotal').innerHTML = text
                // document.getElementById('grandsTotals').innerHTML = text
                document.getElementById('messa').innerHTML = text

            }

        </script> -->
        <!-- coupon======= -->
        <script>

            let orderData = '<%=JSON.stringify(order)%>'
            console.log(orderData + "hehe")
            orderData = JSON.parse(orderData.replace(/&#34;/g, '"'));
            $(document).ready(() => {
                if (orderData) {
                    x()
                }
            })
            console.log(orderData)

            var options = {
                "key": 'rzp_test_A2tpP62NDFg7Wm', // Enter the Key ID generated from the Dashboard
                "amount": orderData.amount * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                "currency": "INR",
                "name": "VK fashion",
                "description": "Test Transaction",
                "image": "https://example.com/your_logo",
                "order_id": orderData.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                "handler": function (response) {
                    success()
                },
                "prefill": {
                    "name": "Gaurav Kumar",
                    "email": "gaurav.kumar@example.com",
                    "contact": "9000090000"
                },
                "notes": {
                    "address": "Razorpay Corporate Office"
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
            });
            // document.getElementById('rzp-button1').onclick = function(e){
            function x() {
                rzp1.open();
                // e.preventDefault();
            }
            function success() {
                $.ajax({

                    type: "GET",
                    url: "/razorpay",
                    contentType: 'application/json',
                    success: function (datas) {
                        console.log('khjghg');
                        console.log(datas)

                        location.href = '/sucessPage?id=' + datas
                    }
                })

            }
        </script>

        <script>

            function discount() {
                let couponId = document.getElementById('coupon').value
                let grandtotal = document.getElementById('grandTotal').textContent
                let subtotal = document.getElementById('total').textContent

                // ====




                // ===

                const xhttp = new XMLHttpRequest()

                $.ajax({
                    type: 'post',
                    url: `/coupon`,
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({ couponId, grandtotal, subtotal }),
                    success: (data) => {

                        if (data.wrong != 1) {
                            if (data.discount) {
                                document.getElementById('percentage').innerHTML = data.discount;
                                document.getElementById('grandTotal').innerHTML = data.discountSubtotal
                                // document.getElementById('grandsTotals').innerHTML = data.discountSubtotal

                                document.getElementById('messa').innerHTML = data.messa

                            } else {
                                document.getElementById('percentage').innerHTML = data.maxDiscount;
                                document.getElementById('grandTotal').innerHTML = data.discountSubtotal
                                // document.getElementById('grandsTotals').innerHTML = data.discountSubtotal

                                document.getElementById('messa').innerHTML = data.messa


                            }


                        } else {
                            document.getElementById('messa').innerHTML = data.messa

                        }
                    }
                })
            }
        </script>






        <!-- ajax address -->
        <script>
            $(document).ready(function () {
                $('#orderform').submit(function (e) {
                    e.preventDefault();
                    var error = false;

                    // Validate full name
                    var name = $('#fname').val().trim();
                    if (!name) {
                        $('#lname-error').text('Please enter your full name');
                        error = true;
                        $('#fname')
                    } else {
                        $('#name-error').text('');
                    }
                    // Validate last name
                    var lname = $('#lname').val().trim();
                    if (!lname) {
                        $('#name-error').text('Please enter your full name');
                        error = true;
                        $('#lname')
                    } else {
                        $('#lname-error').text('');
                    }

                    // Validate house name
                    var housename = $('#address').val();
                    if (!housename) {
                        $('#house-error').text('Please enter your house name');
                        error = true;
                        $('#address')
                    } else {
                        $('#house-error').text('');
                    }

                    // Validate pincode
                    var pincode = $('#zipCode').val();
                    var pincode_regex = /^[0-9]{6}$/;
                    if (!pincode || !pincode_regex.test(pincode)) {
                        $('#pincode-error').text('Please enter a valid 6-digit pincode');
                        error = true;
                    } else {
                        $('#pincode-error').text('');
                    }

                    // Validate city
                    var city = $('#country').val();
                    if (!city) {
                        $('#country-error').text('Please enter your city');
                        error = true;
                    } else {
                        $('#country-error').text('');
                    }

                    // Validate district
                    var district = $('#city').val();
                    if (!district) {
                        $('#district-error').text('Please enter your district');
                        error = true;
                    } else {
                        $('#district-error').text('');
                    }
                    // Validate state
                    var state = $('#state').val();
                    if (!state) {
                        $('#state-error').text('Please enter your state');
                        error = true;
                    } else {
                        $('#state-error').text('');
                    }

                    // Validate mobile number
                    var mobilenumber = $('#Mobile').val();
                    var mobilenumber_regex = /^[0-9]{10}$/;
                    if (!mobilenumber || !mobilenumber_regex.test(mobilenumber)) {
                        $('#phone-error').text('Please enter a valid 10-digit mobile number');
                        error = true;
                    } else {
                        $('#phone-error').text('');
                    }

                    // Validate email
                    var email = $('#email').val();
                    var email_regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!email || !email_regex.test(email)) {
                        $('#email-error').text('Please enter a valid email address');
                        error = true;
                    } else {
                        $('#email-error').text('');
                    }


                    // Submit the form if no errors
                    if (!error) {
                        this.submit();
                    }
                });
            });
        </script>



<%- include('../layouts/user/footer.ejs') %>